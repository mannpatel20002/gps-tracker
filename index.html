<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Smart GPS Tracking Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #f1f5f9;
}

#map {
  height: 100vh;
  width: 100%;
}

.header {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  padding: 12px 25px;
  border-radius: 30px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  font-weight: 600;
  font-size: 18px;
  z-index: 1000;
}

.card {
  position: absolute;
  background: white;
  border-radius: 20px;
  padding: 18px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.08);
  z-index: 1000;
  transition: 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
}

#infoCard {
  bottom: 20px;
  left: 20px;
  width: 280px;
}

#statusCard {
  top: 20px;
  right: 20px;
  padding: 10px 20px;
  border-radius: 50px;
  font-weight: 600;
}

.online {
  background: #22c55e;
  color: white;
}

.offline {
  background: #ef4444;
  color: white;
}

.label {
  font-size: 13px;
  color: #64748b;
}

.value {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 8px;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="header">
  ðŸš€ ESP32 Live GPS Tracking System
</div>

<div id="infoCard" class="card">
  <div class="label">Latitude</div>
  <div class="value" id="lat">--</div>

  <div class="label">Longitude</div>
  <div class="value" id="lng">--</div>

  <div class="label">Speed (km/h)</div>
  <div class="value" id="speed">0</div>

  <div class="label">Total Distance (km)</div>
  <div class="value" id="distance">0</div>

  <div class="label">Last Update</div>
  <div class="value" id="time">--</div>
</div>

<div id="statusCard" class="card online">
  ðŸŸ¢ ONLINE
</div>

<script>

var map = L.map('map').setView([22.0, 72.0], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

var marker = L.marker([22.0, 72.0]).addTo(map);
var pathLine = L.polyline([], {color: '#2563eb', weight: 4}).addTo(map);

let lastLat = null;
let lastLng = null;
let totalDistance = 0;

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function updateLocation() {
  fetch("https://gps-tracker-q2yf.onrender.com/location")
    .then(res => res.json())
    .then(data => {

      if(data.lat && data.lng){

        var newLatLng = new L.LatLng(data.lat, data.lng);
        marker.setLatLng(newLatLng);
        map.panTo(newLatLng);
        pathLine.addLatLng(newLatLng);

        document.getElementById("lat").innerHTML = data.lat.toFixed(6);
        document.getElementById("lng").innerHTML = data.lng.toFixed(6);

        let speed = 0;

        if(lastLat !== null){
          let dist = calculateDistance(lastLat, lastLng, data.lat, data.lng);
          totalDistance += dist;
          speed = (dist * 3600) / 5;
        }

        document.getElementById("speed").innerHTML = speed.toFixed(2);
        document.getElementById("distance").innerHTML = totalDistance.toFixed(3);
        document.getElementById("time").innerHTML = new Date().toLocaleTimeString();

        lastLat = data.lat;
        lastLng = data.lng;

        document.getElementById("statusCard").className = "card online";
        document.getElementById("statusCard").innerHTML = "ðŸŸ¢ ONLINE";
      }

    })
    .catch(err => {
      document.getElementById("statusCard").className = "card offline";
      document.getElementById("statusCard").innerHTML = "ðŸ”´ OFFLINE";
    });
}

updateLocation();
setInterval(updateLocation, 5000);

</script>

</body>
</html>
